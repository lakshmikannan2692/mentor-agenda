<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mentor 1:1 – Simple Agenda</title>
  <style>
    :root{
      --bg:#f2fbf6; --panel:#ffffff; --ink:#1f2937; --muted:#6b7280;
      --brand:#22c55e; --brand-2:#a7f3d0; --chip:#e2f7ed; --border:#d1fae5;
      --blue:#2563eb; --p1:#dcfce7; --p1-border:#86efac;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif}

    .layout{display:grid;grid-template-columns:1fr 320px;gap:16px;max-width:1200px;margin:0 auto;padding:18px}
    @media (max-width:1024px){ .layout{grid-template-columns:1fr} }

    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .h1{font-weight:700;font-size:18px}
    .sub{font-size:12px;color:var(--muted)}

    .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);font-weight:600}
    .btn{border:1px solid var(--border);background:white;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn:hover{border-color:#bff3de}
    .btn.primary{background:linear-gradient(90deg, var(--brand), #86efac);color:#053b1a;border:none}
    .btn.toggle.active{outline:2px solid var(--brand)}
    select, input[type="text"], input[type="email"], input[type="url"], textarea, input[type="date"]{
      width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:white
    }
    textarea{min-height:90px;resize:vertical}

    .tabs{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:white;cursor:pointer;font-weight:600}
    .tab.active{background:var(--brand-2);border-color:#b5f2da}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin:12px 0}
    .card h2{margin:0 0 8px 0;font-size:16px}
    .muted{color:var(--muted);font-size:12px}

    /* Projects & Tasks */
    .project{border:1px dashed var(--border);border-radius:12px;padding:12px;margin:10px 0;background:#fff}
    .proj-head{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .tasks{margin-top:10px;display:flex;flex-direction:column;gap:8px}

    .task{display:grid;grid-template-columns:34px 28px 1fr 140px 140px;gap:8px;align-items:start;border:1px solid var(--border);border-radius:10px;padding:8px;background:#fff}
    .task.p1{background:var(--p1);border-color:var(--p1-border)}
    .drag{cursor:grab;user-select:none}
    .badge{display:flex;flex-direction:column;align-items:center;gap:2px}
    .prio-badge{width:24px;height:24px;border-radius:999px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-weight:700;background:var(--chip)}
    .prev{font-size:11px;color:var(--muted)}
    .task .meta{grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:720px){
      .task{grid-template-columns:34px 28px 1fr}
      .task select.status, .task select.phase, .task select.pgroup{grid-column:1 / -1}
      .task .meta{grid-template-columns:1fr}
    }

    .links{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .alink{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#fff;border:1px solid var(--border);text-decoration:none;color:var(--blue)}

    .history{display:flex;flex-direction:column;gap:8px}
    .history .row{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);padding:10px;border-radius:10px;background:#fff}

    .sidebar .card{margin:0 0 12px 0}
    .sidebar h3{margin:0 0 8px 0}
    .history-list{max-height:50vh;overflow:auto}

    @media print{ .noprint{display:none !important} body{background:white} }
  </style>
</head>
<body>
<script>
  // Auto cache-bust the plain URL once per session
  (function(){
    try{
      const u = new URL(location.href);
      if(!u.searchParams.has('v') && !sessionStorage.getItem('cache_busted')){
        u.searchParams.set('v', Date.now());
        sessionStorage.setItem('cache_busted','1');
        location.replace(u.toString());
      }
    }catch(e){}
  })();
</script>

<div class="layout">
  <main>
    <header>
      <div>
        <div class="h1">Mentor 1:1 – Simple Agenda</div>
        <div class="sub">Auto date/time • Numbered priorities (1, 1.a/1.b) • Grants • Next‑week • History & comparison</div>
      </div>
      <div class="bar noprint">
        <span class="pill" id="now"></span>

        <!-- Meeting spaces -->
        <select id="spaceSelect" style="min-width:180px"></select>
        <button class="btn" id="spaceNewBtn">+ New space</button>
        <button class="btn" id="spaceRenameBtn" title="Rename current space">Rename</button>
        <button class="btn" id="spaceDeleteBtn" title="Delete current space">Delete</button>

        <input id="mentorEmail" type="email" placeholder="Mentor email" style="min-width:200px">
        <button class="btn toggle" id="filterP1" aria-pressed="false" title="Show only priority #1 items">Show P1 only</button>
        <button class="btn" id="exportBtn">Export</button>
        <button class="btn" id="importBtn">Import</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button class="btn" id="printBtn">Save PDF</button>
        <button class="btn" id="copyFullBtn">Copy full</button>
        <button class="btn" id="copyShortBtn">Copy short</button>
        <button class="btn" id="sendShortBtn">Send short</button>
        <button class="btn" id="meetingDoneBtn" title="Create & email the weekly summary">Meeting done</button>
        <button class="btn primary" id="archiveBtn" title="Save a snapshot for this week (freezes priorities)">Archive Week</button>
      </div>
    </header>

    <div class="tabs noprint">
      <div class="tab active" data-tab="projects">Projects</div>
      <div class="tab" data-tab="grants">Grants</div>
      <div class="tab" data-tab="next">Next Week Plan</div>
      <div class="tab" data-tab="history">History</div>
    </div>

    <!-- Projects -->
    <section class="card" id="tab-projects">
      <h2>Projects</h2>
      <div class="muted">Add tasks; choose a <b>Priority Group</b> (1, 2, 3…). Multiple tasks can share “1” → labels 1.a, 1.b, etc. Drag ☰ to order within a group. Archiving preserves that week’s labels.</div>
      <div id="projects"></div>
      <div class="bar noprint" style="margin-top:8px">
        <input id="newProjectName" type="text" placeholder="Project name" style="flex:1">
        <button class="btn" id="addProject">+ Add Project</button>
      </div>
    </section>

    <!-- Grants -->
    <section class="card" id="tab-grants" style="display:none">
      <h2>Grants</h2>
      <div class="muted">Track title, mechanism, deadline, status, notes, and next actions.</div>
      <div id="grants"></div>
      <div class="bar noprint" style="margin-top:8px">
        <input id="newGrantTitle" type="text" placeholder="Grant title" style="flex:1">
        <button class="btn" id="addGrant">+ Add Grant</button>
      </div>
    </section>

    <!-- Next week -->
    <section class="card" id="tab-next" style="display:none">
      <h2>Next Week Plan</h2>
      <div class="muted">Add or carry‑over items; priority labeling works the same way (1, 1.a/1.b).</div>
      <div id="nextWeek" class="tasks"></div>
      <div class="bar noprint" style="margin-top:8px">
        <button class="btn" id="carryFromProjects">← Carry from Projects (non‑Completed)</button>
        <button class="btn" id="addNext">+ Add Item</button>
      </div>
    </section>

    <!-- History -->
    <section class="card" id="tab-history" style="display:none">
      <h2>History</h2>
      <div class="muted">“Archive Week” saves a snapshot. Each snapshot preserves that week’s priority labels for comparison.</div>
      <div id="history" class="history"></div>
    </section>

    <footer class="muted" style="margin:16px 4px">Data saves automatically in your browser. Use Export/Import to move between devices.</footer>
  </main>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="card">
      <h3>Jump to date</h3>
      <input type="date" id="datePicker">
      <div class="bar" style="margin-top:8px">
        <button class="btn" id="goToDateBtn">Go</button>
        <button class="btn" id="clearDateBtn">Clear</button>
      </div>
    </div>

    <div class="card">
      <h3>History (this space)</h3>
      <div class="muted" style="margin-bottom:6px">Click a week to view/restore. Use date picker to filter.</div>
      <div id="historyList" class="history-list"></div>
    </div>
  </aside>
</div>

<!-- Templates -->
<template id="tpl-project">
  <div class="project">
    <div class="proj-head">
      <input class="pname" type="text" placeholder="Project name" />
      <div class="bar">
        <button class="btn addTask">+ Task</button>
        <label class="btn" style="cursor:pointer">
          Upload
          <input class="uploadInput" type="file" multiple style="display:none" />
        </label>
        <button class="btn delProj" title="Delete project">Delete</button>
      </div>
    </div>
    <div class="links"></div>
    <div class="bar" style="margin-top:6px">
      <input class="linkLabel" type="text" placeholder="Link label" style="flex:1">
      <input class="linkUrl" type="url" placeholder="https://" style="flex:1">
      <button class="btn addLink">Add Link</button>
    </div>
    <div class="tasks"></div>
  </div>
</template>

<template id="tpl-task">
  <div class="task" draggable="true">
    <div class="drag" title="Drag to reorder">☰</div>
    <div class="badge">
      <div class="prio-badge" title="Current priority">–</div>
      <div class="prev" title="Last week priority (if archived)"></div>
    </div>
    <input class="title" type="text" placeholder="Task title" />
    <select class="status">
      <option>Planned</option>
      <option>In‑Progress</option>
      <option>Blocked</option>
      <option>Review</option>
      <option>Completed</option>
    </select>
    <select class="phase">
      <option value="">— Stage —</option>
      <option>Design</option>
      <option>Data Collection</option>
      <option>Analysis</option>
      <option>Writing</option>
    </select>
    <div class="meta">
      <textarea class="progress" placeholder=""></textarea>
      <textarea class="blockers" placeholder=""></textarea>
      <div style="grid-column:1/-1;display:grid;grid-template-columns:1fr 200px;gap:8px;align-items:center">
        <input class="reviewer" type="text" placeholder="Reviewer (optional)">
        <select class="pgroup" title="Priority group">
          <option value="">— Priority —</option>
          <option value="1">Priority 1</option>
          <option value="2">Priority 2</option>
          <option value="3">Priority 3</option>
          <option value="4">Priority 4</option>
          <option value="5">Priority 5</option>
        </select>
      </div>
    </div>
  </div>
</template>

<template id="tpl-grant">
  <div class="project">
    <div class="proj-head">
      <input class="gtitle" type="text" placeholder="Grant title" />
      <div class="bar">
        <button class="btn delGrant">Delete</button>
      </div>
    </div>
    <div class="tasks">
      <div class="task" style="grid-template-columns:34px 28px 1fr 180px 160px">
        <div></div><div></div>
        <input class="mech" type="text" placeholder="Mechanism">
        <input class="deadline" type="date">
        <select class="gstatus">
          <option>Ideation</option>
          <option>Drafting</option>
          <option>Internal Review</option>
          <option>PI Review</option>
          <option>Submission Prep</option>
          <option>Submitted</option>
          <option>Decision</option>
        </select>
        <div class="meta">
          <textarea class="gnotes" placeholder=""></textarea>
          <textarea class="gactions" placeholder=""></textarea>
        </div>
      </div>
    </div>
  </div>
</template>

<template id="tpl-next">
  <div class="task" draggable="true">
    <div class="drag">☰</div>
    <div class="badge">
      <div class="prio-badge">–</div>
      <div class="prev"></div>
    </div>
    <input class="title" type="text" placeholder="Item" />
    <select class="status">
      <option>Planned</option>
      <option>In‑Progress</option>
      <option>Blocked</option>
      <option>Review</option>
      <option>Completed</option>
    </select>
    <select class="phase">
      <option value="">— Stage —</option>
      <option>Design</option>
      <option>Data Collection</option>
      <option>Analysis</option>
      <option>Writing</option>
    </select>
    <div class="meta">
      <textarea class="progress" placeholder=""></textarea>
      <textarea class="blockers" placeholder=""></textarea>
      <div style="grid-column:1/-1;display:grid;grid-template-columns:1fr 200px;gap:8px;align-items:center">
        <div></div>
        <select class="pgroup" title="Priority group">
          <option value="">— Priority —</option>
          <option value="1">Priority 1</option>
          <option value="2">Priority 2</option>
          <option value="3">Priority 3</option>
          <option value="4">Priority 4</option>
          <option value="5">Priority 5</option>
        </select>
      </div>
    </div>
  </div>
</template>

<script>
(() => {
  const $ = (s,ctx=document)=>ctx.querySelector(s);
  const $$ = (s,ctx=document)=>Array.from(ctx.querySelectorAll(s));

  /* ---------- Spaces (multiple meetings) ---------- */
  const SPACES_KEY = 'mentor_agenda_spaces_v1';  // list of space names
  const STATE_KEY = (space)=> `mentor_agenda_state_v9_${space}`;
  const DEFAULT_SPACE = 'Mentor 1:1';

  function readSpaces(){ try{return JSON.parse(localStorage.getItem(SPACES_KEY)||'[]');}catch{ return []; } }
  function writeSpaces(list){ localStorage.setItem(SPACES_KEY, JSON.stringify(list)); }
  function ensureDefaultSpace(){
    let list = readSpaces();
    if(list.length===0){ list=[DEFAULT_SPACE]; writeSpaces(list); writeState(DEFAULT_SPACE, {}); }
    return list;
  }

  function readState(space){ try{return JSON.parse(localStorage.getItem(STATE_KEY(space))||'{}');}catch{ return {}; } }
  function writeState(space, data){ localStorage.setItem(STATE_KEY(space), JSON.stringify(data)); }

  let currentSpace = ensureDefaultSpace()[0];

  function refreshSpaceDropdown(){
    const list = readSpaces();
    const sel = $('#spaceSelect');
    sel.innerHTML='';
    list.forEach(name=>{
      const opt=document.createElement('option'); opt.value=name; opt.textContent=name; sel.appendChild(opt);
    });
    sel.value = currentSpace;
  }

  $('#spaceNewBtn').addEventListener('click', ()=>{
    const name = prompt('New meeting space name:', `New space ${Date.now()%1000}`);
    if(!name) return;
    const list = readSpaces();
    if(list.includes(name)){ alert('That name already exists.'); return; }
    list.push(name); writeSpaces(list); writeState(name, {});
    currentSpace = name; refreshSpaceDropdown(); loadSpace();
  });

  $('#spaceRenameBtn').addEventListener('click', ()=>{
    const list = readSpaces();
    const idx = list.indexOf(currentSpace); if(idx<0) return;
    const name = prompt('Rename space:', currentSpace);
    if(!name || name===currentSpace) return;
    if(list.includes(name)){ alert('That name already exists.'); return; }
    // migrate state
    const st = readState(currentSpace);
    localStorage.removeItem(STATE_KEY(currentSpace));
    writeState(name, st);
    list[idx]=name; writeSpaces(list);
    currentSpace = name; refreshSpaceDropdown(); loadSpace();
  });

  $('#spaceDeleteBtn').addEventListener('click', ()=>{
    const list = readSpaces();
    if(list.length<=1){ alert('Keep at least one space.'); return; }
    if(!confirm(`Delete space "${currentSpace}"? This removes its local data and history.`)) return;
    localStorage.removeItem(STATE_KEY(currentSpace));
    const filtered = list.filter(n=>n!==currentSpace); writeSpaces(filtered);
    currentSpace = filtered[0]; refreshSpaceDropdown(); loadSpace();
  });

  $('#spaceSelect').addEventListener('change', (e)=>{ currentSpace = e.target.value; loadSpace(); });

  /* ---------- Header time ---------- */
  function tick(){ $('#now').textContent = new Date().toLocaleString(undefined,{weekday:'short',year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}); }
  tick(); setInterval(tick, 1000*30);

  /* ---------- Tabs ---------- */
  $$('.tab').forEach(t=> t.addEventListener('click',()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    ['projects','grants','next','history'].forEach(id=> $('#tab-'+id).style.display = (t.dataset.tab===id)?'block':'none');
  }));

  /* ---------- Collect / Populate ---------- */
  function collect(){
    return {
      mentorEmail: $('#mentorEmail').value || '',
      projects: collectProjects(),
      grants: collectGrants(),
      next: collectList($('#nextWeek')),
      history: readState(currentSpace).history || [],
      ts: Date.now()
    };
  }
  function save(){ const s=collect(); const st=readState(currentSpace); writeState(currentSpace, {...st, ...s}); }

  function populate(state){
    $('#mentorEmail').value = state.mentorEmail || '';
    // projects
    $('#projects').innerHTML='';
    (state.projects||[]).forEach(p=> addProject(p));
    // grants
    $('#grants').innerHTML='';
    (state.grants||[]).forEach(g=> addGrant(g));
    // next week
    $('#nextWeek').innerHTML='';
    (state.next||[]).forEach(item=> $('#nextWeek').appendChild(newTask($('#tpl-next'), item)));
    computeAllPriorities();
    updatePrevBadges();
    renderHistory(state.history||[]);
  }

  /* ---------- Export / Import / Print ---------- */
  $('#exportBtn').addEventListener('click',()=>{
    const blob = new Blob([JSON.stringify(collect(),null,2)],{type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${currentSpace.replace(/\\W+/g,'_')}_agenda.json`; a.click();
  });
  $('#importBtn').addEventListener('click',()=> $('#importFile').click());
  $('#importFile').addEventListener('change', e=>{
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=>{ try{ const s=JSON.parse(r.result); populate(s); save(); }catch(err){ alert('Invalid JSON'); } };
    r.readAsText(f);
  });
  $('#printBtn').addEventListener('click', ()=> window.print());

  /* ---------- Priority 1 filter ---------- */
  $('#filterP1').addEventListener('click', (e)=>{
    const btn = e.currentTarget;
    const active = btn.getAttribute('aria-pressed') === 'true';
    btn.setAttribute('aria-pressed', String(!active));
    btn.classList.toggle('active');
    applyP1Filter(!active);
  });
  function applyP1Filter(on){
    $$('.tasks').forEach(list=>{
      $$('.task', list).forEach(t=>{
        const label = $('.prio-badge', t).textContent.trim();
        const isP1 = label.startsWith('1');
        if(on){ t.style.display = isP1 ? 'grid' : 'none'; t.classList.toggle('p1', isP1); }
        else{ t.style.display='grid'; t.classList.toggle('p1', isP1); }
      });
    });
  }

  /* ---------- Archive ---------- */
  $('#archiveBtn').addEventListener('click', ()=>{
    computeAllPriorities();
    const s = collect();
    const d = new Date();
    const wk = isoWeek(d);
    const name = `${d.getFullYear()}‑W${String(wk).padStart(2,'0')} (${d.toLocaleDateString()})`;
    const iso = d.toISOString().slice(0,10);
    // keep priorityLabel + ids
    s.projects.forEach(p=> p.tasks.forEach(t=>{ if(!t.priorityLabel) t.priorityLabel = ''; }));
    s.next.forEach(t=>{ if(!t.priorityLabel) t.priorityLabel = ''; });
    const st = readState(currentSpace);
    st.history = st.history||[];
    st.history.unshift({name, date: iso, data: JSON.parse(JSON.stringify(s)), at: Date.now()});
    writeState(currentSpace, st);
    renderHistory(st.history);
    updatePrevBadges();
    alert('Archived this week! Compare badges updated.');
  });

  /* ---------- Meeting done / short / copy ---------- */
  $('#meetingDoneBtn').addEventListener('click', ()=>{
    computeAllPriorities(); updatePrevBadges();
    const report = buildReport({mode:'full'});
    showReportWindow(report);
    openEmailDraft(report, `[${currentSpace}] Weekly 1:1 summary – ` + new Date().toLocaleDateString());
  });
  $('#sendShortBtn').addEventListener('click', ()=>{
    computeAllPriorities(); updatePrevBadges();
    const report = buildReport({mode:'short'});
    openEmailDraft(report, `[${currentSpace}] Short weekly focus – ` + new Date().toLocaleDateString());
  });
  $('#copyFullBtn').addEventListener('click', ()=>{
    const report = buildReport({mode:'full'}); copyToClipboard(report); alert('Full summary copied to clipboard.');
  });
  $('#copyShortBtn').addEventListener('click', ()=>{
    const report = buildReport({mode:'short'}); copyToClipboard(report); alert('Short summary copied to clipboard.');
  });

  function openEmailDraft(text, subject){
    const email = ($('#mentorEmail').value||'').trim();
    const subj = encodeURIComponent(subject);
    const body = encodeURIComponent(text);
    const href = `mailto:${encodeURIComponent(email)}?subject=${subj}&body=${body}`;
    setTimeout(()=>{ location.href = href; }, 200);
  }
  function showReportWindow(report){
    const w = window.open('', '_blank');
    w.document.write(`<html><head><title>Weekly Summary</title></head><body><pre>${escapeHtml(report)}</pre></body></html>`); w.document.close();
  }
  function buildReport({mode}){
    const d = new Date();
    let out = '';
    out += `${currentSpace} — Mentor 1:1 Summary\n`;
    out += `${d.toLocaleString()}\n\n`;
    const includeP1Only = (mode==='short');

    // Projects
    $$('#projects .project').forEach(p=>{
      const name = $('.pname', p).value || '(untitled project)';
      let any = false; const lines = [];
      const tasks = $$('.task', p);
      tasks.forEach(t=>{
        const label = $('.prio-badge', t).textContent.trim(); if(!label) return;
        const isP1 = label.startsWith('1'); if(includeP1Only && !isP1) return;
        const prev = ($('.prev', t).textContent||'').trim();
        const title = $('.title', t).value.trim();
        const status = $('.status', t).value;
        const phase = $('.phase', t).value;
        const prog = ($('.progress', t).value||'').trim();
        const block = ($('.blockers', t).value||'').trim();
        lines.push(`  ${label}${prev?` (was ${prev})`:''} — ${title} [${status}${phase?`, ${phase}`:''}]`);
        if(mode==='full'){
          if(prog) lines.push(`    Progress: ${prog}`);
          if(block) lines.push(`    Roadblocks: ${block}`);
        }
        any = true;
      });
      if(any){
        out += `Project: ${name}\n`;
        const links = $$('.links .alink', p).map(a=>`- ${a.textContent}: ${a.href}`).join('\n');
        if(mode==='full' && links) out += links + '\n';
        out += lines.join('\n') + '\n\n';
      }
    });

    // Next Week Plan (always included)
    const nxt = $$('#nextWeek .task');
    if(nxt.length){
      out += `Next Week Plan\n`;
      nxt.forEach(t=>{
        const label = $('.prio-badge', t).textContent.trim() || '–';
        const title = $('.title', t).value.trim();
        const status = $('.status', t).value;
        const phase = $('.phase', t).value;
        const prog = ($('.progress', t).value||'').trim();
        const block = ($('.blockers', t).value||'').trim();
        out += `  ${label} — ${title} [${status}${phase?`, ${phase}`:''}]\n`;
        if(mode==='full'){
          if(prog) out += `    Details: ${prog}\n`;
          if(block) out += `    Roadblocks: ${block}\n`;
        }
      });
      out += `\n`;
    }

    // Grants (only in full)
    if(mode==='full'){
      const gs = $$('#grants .project');
      if(gs.length){
        out += `Grants\n`;
        gs.forEach(g=>{
          const t = $('.gtitle', g).value||'(untitled)';
          const mech = $('.mech', g).value||'';
          const dl = $('.deadline', g).value||'';
          const st = $('.gstatus', g).value||'';
          const notes = ($('.gnotes', g).value||'').trim();
          const actions = ($('.gactions', g).value||'').trim();
          out += `  ${t} — ${mech}${dl?` (deadline ${dl})`:''} [${st}]\n`;
          if(notes) out += `    Notes: ${notes}\n`;
          if(actions) out += `    Next: ${actions}\n`;
        });
        out += `\n`;
      }
    }
    return out || 'Summary is empty.';
  }

  function copyToClipboard(text){
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).catch(()=> fallbackCopy(text));
    }else{ fallbackCopy(text); }
  }
  function fallbackCopy(text){
    const ta = document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
  }
  function escapeHtml(s){ return s.replace(/[&<>\"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  function isoWeek(d){
    const t=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
    const day=(t.getUTCDay()+6)%7; t.setUTCDate(t.getUTCDate()-day+3);
    const first=new Date(Date.UTC(t.getUTCFullYear(),0,4));
    return 1+Math.round(((t-first)/86400000-3+((first.getUTCDay()+6)%7))/7);
  }

  /* ---------- Projects / Grants / Tasks ---------- */
  $('#addProject').addEventListener('click',()=> addProject());
  $('#addGrant').addEventListener('click',()=> addGrant());
  $('#carryFromProjects').addEventListener('click',()=>{
    computeAllPriorities();
    const s = collect();
    const flat = [];
    (s.projects||[]).forEach(p=> (p.tasks||[]).forEach(t=>{ if(t.status!=='Completed'){ flat.push({...t}); }}));
    $('#nextWeek').innerHTML='';
    flat.forEach(t=> $('#nextWeek').appendChild(newTask($('#tpl-next'), t)));
    computePriorities($('#nextWeek')); save(); updatePrevBadges();
  });
  $('#addNext').addEventListener('click',()=>{ $('#nextWeek').appendChild(newTask($('#tpl-next'))); computePriorities($('#nextWeek')); save(); updatePrevBadges(); });

  function addProject(p={name:$('#newProjectName').value.trim(), links:[], tasks:[]}){
    const el = $('#tpl-project').content.firstElementChild.cloneNode(true);
    $('.pname', el).value = p.name||'';
    const linksWrap = $('.links', el);
    (p.links||[]).forEach(l=> linksWrap.appendChild(linkPill(l)));

    // uploads → small inline data URLs
    const up = $('.uploadInput', el);
    up.addEventListener('change', async (ev)=>{
      for(const file of ev.target.files){
        if(file.size > 2*1024*1024){ alert(`${file.name} is over 2MB; consider linking via Drive instead.`); continue; }
        const url = await fileToDataURL(file);
        linksWrap.appendChild(linkPill({label:`${file.name}`, url}));
      }
      save(); up.value='';
    });

    const tasks = $('.tasks', el);
    (p.tasks||[]).forEach(t=> tasks.appendChild(newTask($('#tpl-task'), t)));

    // Add link
    $('.addLink', el).addEventListener('click',()=>{
      const label = $('.linkLabel', el).value.trim();
      const url = $('.linkUrl', el).value.trim();
      if(label && url){ linksWrap.appendChild(linkPill({label,url})); $('.linkLabel', el).value=''; $('.linkUrl', el).value=''; save(); }
    });

    // Add task
    $('.addTask', el).addEventListener('click',()=>{ tasks.appendChild(newTask($('#tpl-task'))); computePriorities(tasks); save(); updatePrevBadges(); });

    // Delete project
    $('.delProj', el).addEventListener('click',()=>{ if(confirm('Delete this project?')){ el.remove(); save(); }});

    // Dragging within project
    enableDrag(tasks);

    $('#projects').appendChild(el);
    $('#newProjectName').value='';
    computePriorities(tasks); save(); updatePrevBadges();
  }

  function addGrant(g={title:$('#newGrantTitle').value.trim()}){
    const el = $('#tpl-grant').content.firstElementChild.cloneNode(true);
    $('.gtitle', el).value = g.title||'';
    $('.mech', el).value = g.mech||'';
    $('.deadline', el).value = g.deadline||'';
    $('.gstatus', el).value = g.status||'Ideation';
    $('.gnotes', el).value = g.notes||'';
    $('.gactions', el).value = g.actions||'';
    $('.delGrant', el).addEventListener('click',()=>{ if(confirm('Delete this grant?')){ el.remove(); save(); }});
    $$('input, textarea, select', el).forEach(i=> i.addEventListener('input', debounce(()=>{ save(); },150)));
    $('#grants').appendChild(el);
    $('#newGrantTitle').value=''; save();
  }

  function newTask(template, data={}){
    const el = template.content.firstElementChild.cloneNode(true);
    el.dataset.id = data.id || ('t_'+Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(-4));
    $('.title', el).value = data.title||'';
    $('.status', el).value = data.status||'Planned';
    const ph = $('.phase', el); if(ph) ph.value = data.phase||'';
    const pr = $('.progress', el); if(pr) pr.value = data.progress||'';
    const bl = $('.blockers', el); if(bl) bl.value = data.blockers||'';
    const rv = $('.reviewer', el); if(rv) rv.value = data.reviewer||'';
    const pg = $('.pgroup', el); if(pg) pg.value = data.pgroup||'';
    if(data.priorityLabel){ el.dataset.priorityLabel = data.priorityLabel; }

    $$('input, textarea, select', el).forEach(i=> i.addEventListener('input', debounce(()=>{ computeAllPriorities(); save(); updatePrevBadges(); },150)));
    el.addEventListener('dragstart', e=>{ el.classList.add('dragging'); e.dataTransfer.setData('text/plain',''); });
    el.addEventListener('dragend', ()=>{ el.classList.remove('dragging'); const parent = el.parentElement; computePriorities(parent); save(); updatePrevBadges(); });

    return el;
  }

  function enableDrag(container){
    container.addEventListener('dragover', e=>{
      e.preventDefault();
      const dragging = container.querySelector('.dragging');
      const after = getDragAfterElement(container, e.clientY);
      if(!after) container.appendChild(dragging); else container.insertBefore(dragging, after);
      computePriorities(container);
    });
  }
  function getDragAfterElement(container, y){
    const els = [...container.querySelectorAll('.task:not(.dragging)')];
    return els.reduce((closest, child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      if(offset < 0 && offset > closest.offset){ return { offset, element: child }; }
      else return closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  function fileToDataURL(file){
    return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
  }
  function linkPill({label,url}){ const a=document.createElement('a'); a.href=url; a.target='_blank'; a.className='alink'; a.textContent=label; return a; }

  function collectProjects(){
    return $$('#projects .project').map(p=>({
      name: $('.pname', p).value,
      links: $$('.links .alink', p).map(a=>({label:a.textContent, url:a.href})),
      tasks: collectList($('.tasks', p))
    }));
  }
  function collectList(container){
    return $$('.task', container).map(t=>({
      id: t.dataset.id,
      title: $('.title', t).value||'',
      status: $('.status', t).value||'Planned',
      phase: $('.phase', t)? $('.phase', t).value: '',
      progress: $('.progress', t)? $('.progress', t).value: '',
      blockers: $('.blockers', t)? $('.blockers', t).value: '',
      reviewer: $('.reviewer', t)? $('.reviewer', t).value: '',
      pgroup: $('.pgroup', t)? $('.pgroup', t).value: '',
      priorityLabel: t.dataset.priorityLabel || ''
    }));
  }
  function collectGrants(){
    return $$('#grants .project').map(g=>({
      title: $('.gtitle', g).value,
      mech: $('.mech', g).value,
      deadline: $('.deadline', g).value,
      status: $('.gstatus', g).value,
      notes: $('.gnotes', g).value,
      actions: $('.gactions', g).value
    }));
  }

  /* ---------- Priority computation ---------- */
  function computeAllPriorities(){
    $$('#projects .project .tasks').forEach(container=> computePriorities(container));
    computePriorities($('#nextWeek'));
  }
  function computePriorities(container){
    if(!container) return;
    const tasks = $$('.task', container);
    const groups = {};
    tasks.forEach(t=>{
      const g = ($('.pgroup', t)?.value)||'';
      (groups[g] = groups[g] || []).push(t);
    });
    const ordered = Object.keys(groups)
      .filter(k=>k!=='')
      .map(k=>parseInt(k,10))
      .sort((a,b)=>a-b)
      .map(n=>String(n));

    tasks.forEach(t=> t.classList.remove('p1'));

    ordered.forEach(g=>{
      const list = groups[g];
      list.forEach((t,idx)=>{
        const label = list.length>1 ? `${g}.${String.fromCharCode(97+idx)}` : g;
        $('.prio-badge', t).textContent = label;
        t.dataset.priorityLabel = label;
        if(g==='1'){ t.classList.add('p1'); }
      });
    });

    (groups['']||[]).forEach(t=>{ $('.prio-badge',t).textContent='–'; t.dataset.priorityLabel=''; });
  }

  /* ---------- History + Calendar ---------- */
  function renderHistory(list){
    const h = $('#history'); h.innerHTML='';
    const side = $('#historyList'); side.innerHTML='';

    (list||[]).forEach((snap)=>{
      // Main History tab rows
      const row = document.createElement('div'); row.className='row';
      const left = document.createElement('div'); left.innerHTML = `<b>${snap.name}</b><div class="muted">Saved ${new Date(snap.at).toLocaleString()}</div>`;
      const right = document.createElement('div'); right.className='bar';
      const view = document.createElement('button'); view.className='btn'; view.textContent='View';
      const restore = document.createElement('button'); restore.className='btn'; restore.textContent='Restore to current';
      right.appendChild(view); right.appendChild(restore);
      row.appendChild(left); row.appendChild(right);
      h.appendChild(row);

      view.addEventListener('click',()=> openSnapshotView(snap));
      restore.addEventListener('click',()=>{ if(confirm('Replace current agenda with this archive?')){ populate(snap.data); save(); } });

      // Sidebar list items
      const item = document.createElement('div');
      item.className='row';
      item.style.display='flex'; item.style.justifyContent='space-between';
      const txt = document.createElement('div'); txt.innerHTML = `<b>${snap.date}</b><div class="muted">${snap.name}</div>`;
      const btns = document.createElement('div'); btns.className='bar';
      const v = document.createElement('button'); v.className='btn'; v.textContent='View';
      const r = document.createElement('button'); r.className='btn'; r.textContent='Restore';
      btns.appendChild(v); btns.appendChild(r);
      item.appendChild(txt); item.appendChild(btns);
      side.appendChild(item);
      v.addEventListener('click',()=> openSnapshotView(snap));
      r.addEventListener('click',()=>{ if(confirm('Replace current agenda with this archive?')){ populate(snap.data); save(); } });
    });
  }

  function openSnapshotView(snap){
    const w = window.open('', '_blank');
    w.document.write('<h3>'+snap.name+'</h3>');
    (snap.data.projects||[]).forEach(p=>{
      w.document.write('<h4>Project: '+(p.name||'(untitled)')+'</h4><ol>');
      (p.tasks||[]).forEach(t=>{
        const pl = t.priorityLabel || '?';
        w.document.write('<li><b>'+pl+'</b> '+(t.title||'')+' — '+(t.status||'')+'</li>');
      });
      w.document.write('</ol>');
    });
    if((snap.data.next||[]).length){
      w.document.write('<h4>Next Week snapshot</h4><ol>');
      (snap.data.next||[]).forEach(t=>{
        const pl = t.priorityLabel || '?';
        w.document.write('<li><b>'+pl+'</b> '+(t.title||'')+' — '+(t.status||'')+'</li>');
      });
      w.document.write('</ol>');
    }
    w.document.close();
  }

  // Calendar date filter
  $('#goToDateBtn').addEventListener('click', ()=>{
    const val = $('#datePicker').value;
    const st = readState(currentSpace);
    const match = (st.history||[]).find(h=> h.date === val);
    if(match){ openSnapshotView(match); }
    else { alert('No archive found for that date. (Use Archive Week after a meeting.)'); }
  });
  $('#clearDateBtn').addEventListener('click', ()=>{ $('#datePicker').value=''; });

  /* ---------- Compare-to-last-week badges ---------- */
  function updatePrevBadges(){
    const st = readState(currentSpace);
    const hist = (st.history||[]);
    if(!hist.length) { $$('.prev').forEach(e=> e.textContent=''); return; }
    const last = hist[0].data;
    const prevIndex = new Map();
    (last.projects||[]).forEach(p=> (p.tasks||[]).forEach(t=>{ if(t.id) prevIndex.set(t.id, t.priorityLabel||''); }));
    (last.next||[]).forEach(t=>{ if(t.id) prevIndex.set(t.id, t.priorityLabel||''); });
    $$('.task').forEach(t=>{
      const id = t.dataset.id; const prev = prevIndex.get(id);
      const el = $('.prev', t); el.textContent = prev ? `was ${prev}` : '';
    });
  }

  /* ---------- Init ---------- */
  function loadSpace(){
    refreshSpaceDropdown();
    const st = readState(currentSpace);
    populate(st);
  }

  // Wire page-level events that depend on DOM being ready
  window.addEventListener('DOMContentLoaded', ()=>{
    refreshSpaceDropdown();
    loadSpace();
  });

})();
</script>
</body>
</html>
